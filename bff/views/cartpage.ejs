<div class="microservice-layout">
    <div class="header-login">
        <div class="header-left">
            <span class="header-left_logo">
                <img src="OIP.jpg" alt="">
            </span>
            <span class="header-left_icon-homepage">
                <i class="fa-solid fa-house"></i>
            </span>
            <div class="header-left_search">
                <!-- Hoi chat gpt xem cái khung search này template như nào-->
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Nội dung bạn muốn tìm kiếm?">
                <i class="fa-solid fa-folder-open"></i>
            </div>
            <div class="header-left_search--history">
                <div class="header-left_search--history-header">Các tìm kiếm gần đây</div>
                <div class="header-left_search--history-item">
                    <img src="ST.jpg" alt="st-MTP" class="header-left_search--history-icon">
                    <div class="header-left_search--history-texts">
                        <div class="header-left_search--history-title">Cà phê sữa</div>
                        <div class="header-left_search--history-subtitle">25.000Đ</div>
                    </div>
                </div>
                <div class="header-left_search--history-item">
                    <img src="ST.jpg" alt="st-MTP" class="header-left_search--history-icon">
                    <div class="header-left_search--history-texts">
                        <div class="header-left_search--history-title">Cà phê sữa</div>
                        <div class="header-left_search--history-subtitle">25.000Đ</div>
                    </div>
                </div>
                <button class="header-left_search--history-clear-button">Xoá các tìm kiếm gần đây</button>
            </div>
        </div>
        <% if (user) { %>
            <div class="header-right">
                <div class="header-right_menu">
                    <ul class="header-right_menu--list">
                        <li class="header-right_menu--item">Premium</li>
                        <li class="header-right_menu--item">Hỗ trợ</li>
                        <li class="header-right_menu--item">Tải xuống</li>
                    </ul>
                    <div class="header-right_menu_download">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </div>
                </div>
                <div class="header-right_User">
                    <span class="header-right_User--noti"><i class="fa-solid fa-bell"></i></span>
                    <div class="header-right_User-box--avatar" id="avatarBtn">
                        <span class="header-right_User--avatar">N</span>
                    </div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <div class="dropdown-item">
                            Tài khoản <i class="fa-solid fa-up-right-from-square icon"></i>
                        </div>
                        <div class="dropdown-item selected">
                            Hồ sơ
                        </div>
                        <div class="dropdown-item">
                            Nâng cấp lên Premium <i class="fa-solid fa-up-right-from-square icon"></i>
                        </div>
                        <div class="dropdown-item">
                            Tải xuống <i class="fa-solid fa-up-right-from-square icon"></i>
                        </div>
                        <div class="dropdown-item">
                            Cài đặt
                        </div>
                        <div class="dropdown-divider"></div>
                        <form action="/logout" class="dropdown-item-form logout" method="POST" style="display: inline;"
                            id="logoutForm">
                            <div class="dropdown-item logout">
                                Đăng xuất <i class="fa-solid fa-arrow-right-from-bracket icon"></i>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <% } else { %>
                <div class="header-right">
                    <div class="header-right_menu">
                        <ul class="header-right_menu--list">
                            <li class="header-right_menu--item">Thông tin</li>
                            <li class="header-right_menu--item">Liên hệ</li>
                            <li class="header-right_menu--item">Tải xuống</li>
                        </ul>
                        <div class="header-right_menu_download">
                            <i class="fa-solid fa-right-to-bracket"></i>
                            <span class="header-right_menu_download--text">Đăng nhập cho Admin</span>
                        </div>
                    </div>
                    <div class="header-right_login">
                        <div class="header-right_login--signUp" onclick="window.location.href='/register'">Đăng ký</div>
                        <div class="header-right_login--signIn" onclick="window.location.href='/login'">Đăng nhập</div>
                    </div>
                </div>
                <% } %>
    </div>
    <div class="container">
        <% if (error) { %>
            <div style="background-color: #f44336; color: white; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
                <strong>⚠️ Error:</strong> <%= error %>
            </div>
        <% } %>
        <% if (message) { %>
            <div style="background-color: #00fd15; color: white; padding: 12px; margin-bottom: 16px; border-radius: 6px;">
                <strong>✔️ Success:</strong> <%= message %>
            </div>
        <% } %>
        <!-- size 1/4-->
        <div class="container-sidebar">
            <div class="container-sidebar-homepageNoLogin">
                <ul class="container-sidebar-homepageNoLogin-playlist">
                    <li class="container-sidebar-homepageNoLogin-playlist--item" onclick="window.location.href='/'">
                        <div class="container-sidebar-homepageNoLogin-playlist-info">
                            <a href="/" class="container-sidebar-homepageNoLogin-playlist-title"
                                style="text-decoration: none; color: inherit;">Homepage</a>
                        </div>
                    </li>
                    <li class="container-sidebar-homepageNoLogin-playlist--item"
                        onclick="window.location.href='/products'">
                        <div class="container-sidebar-homepageNoLogin-playlist-info">
                            <a href="/products" class="container-sidebar-homepageNoLogin-playlist-title"
                                style="text-decoration: none; color: inherit;">Product</a>
                        </div>
                    </li>
                    <% if (user) { %>
                        <li class="container-sidebar-homepageNoLogin-playlist--item selected">
                            <div class="container-sidebar-homepageNoLogin-playlist-info"
                                onclick="window.location.href='/cart'">
                                <a href="/cart" class="container-sidebar-homepageNoLogin-playlist-title"
                                    style="text-decoration: none; color: inherit;">Cart</a>
                            </div>
                        </li>
                        <% } %>
                </ul>
            </div>
        </div>
        <!-- size 3/4 -->
        <div class="container-box-content">
            <div class="container-box-content1">
                <div class="container-box-content-cart-page">
                    <h2 class="container-box-content-cart-page-hearder">Giỏ hàng của bạn</h2>
                    <div class="container-box-content-cart-items">
                        <% if (items.length> 0) { %>
                            <% items.forEach(item=> { %>
                                <div class="container-box-content-cart-item" id="<%= item.id %>">
                                    <div class="container-box-content-cart-item-right">
                                        <img src="/assets/images/products/<%= item.image %>" alt="<%= item.name %>"
                                            class="container-box-content-cart-item-image">
                                        <div class="container-box-content-cart-item-right-info">
                                            <span class="container-box-content-cart-page-name">
                                                <%= item.name %>
                                            </span>
                                            <span class="container-box-content-cart-page-cost">
                                                Giá gốc: <%= item.price %>đ
                                            </span>
                                        </div>
                                    </div>
                                    <div class="container-box-content-cart-item-details">
                                        <div class="container-box-content-cart-quantity">
                                            <button class="container-box-content-cart-quantity-btn decrement">-</button>
                                            <input type="number" value="<%= item.quantity %>" min="1"
                                                class="container-box-content-cart-quantity-input">
                                            <button class="container-box-content-cart-quantity-btn increment">+</button>
                                        </div>
                                        <p class="container-box-content-cart-price">
                                            <%= item.totalPrice %>đ
                                        </p>
                                        <button class="container-box-content-cart-remove cart-remover"
                                            data-id="<%= item.id %>">Xóa</button>
                                    </div>
                                </div>

                                <div class="container-box-content-cart-summary">
                                    <p><strong>Tổng cộng: <span>
                                                <%= totalPrice %>đ
                                            </span></strong></p>
                                    <button class="container-box-content-cart-checkout-btn check-out">Tiến hành đặt
                                        hàng</button>
                                </div>
                                <% }) %>
                                    <% } else { %>
                                        <p>Giỏ hàng trống.</p>
                                        <% } %>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.querySelectorAll('.cart-remover').forEach(button => {
        button.addEventListener('click', async () => {
            const productId = button.dataset.id;

            try {
                const res = await fetch(`/cart/delete/${productId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) {
                    const error = await res.json();
                    alert('Xóa thất bại: ' + (error.message || 'Lỗi không xác định'));
                }
                const { eventId } = await res.json();

                                let retries = 3;
                let statusData;
                while (retries-- > 0) {
                    const statusRes = await fetch(`/status/cart/${eventId}`);

                    if (statusData.status === 'completed') {
                        break;
                    }

                    if (statusData.status === 'failed') {
                        alert('Thêm vào giỏ thất bại!');
                        return;
                    }

                    await new Promise(r => setTimeout(r, 2000)); // wait before retry
                }

                if (statusData.status !== 'completed') {
                    alert('Quá thời gian xử lý! Xin thử lại sau.');
                    return;
                }

                document.getElementById(`${productId}`).remove();
            } catch (err) {
                console.error(err);
                alert('Không thể kết nối đến máy chủ.');
            }
        });
    });

    document.querySelectorAll('.check-out').forEach(button => {
        button.addEventListener('click', async () => {
            try {
                const res = await fetch(`/purchase`, {
                    method: 'POST'
                })

            } catch (err) {
                console.error(err);
                alert('Không thể kết nối đến máy chủ.');
            }
        });
    })
</script>